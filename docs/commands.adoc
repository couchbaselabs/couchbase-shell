== Couchbase Commands

The following sections discuss the individual couchbase specific commands in greater detail. Remember, you can always mix and match
them with built-in other shell commands as well as executables from your environment.

=== Working with `clusters`

The `cb-env managed` command lists all the clusters you have registered with the shell.

```
> cb-env managed
╭───┬────────┬───────┬────────────┬───────────────┬──────────────────────╮
│ # │ active │  tls  │ identifier │   username    │ capella_organization │
├───┼────────┼───────┼────────────┼───────────────┼──────────────────────┤
│ 0 │ true   │ false │ dev.local  │ Administrator │                      │
│ 1 │ false  │ true  │ capella    │ charlie       │                      │
╰───┴────────┴───────┴────────────┴───────────────┴──────────────────────╯
```

=== Working with `buckets`

The `buckets` command lists all the buckets from your active cluster:

[options="nowrap"]
```
> buckets
╭───┬───────────┬─────────────┬───────────┬──────────┬──────────────────────┬───────────┬───────────────┬────────┬───────╮
│ # │  cluster  │    name     │   type    │ replicas │ min_durability_level │ ram_quota │ flush_enabled │ status │ cloud │
├───┼───────────┼─────────────┼───────────┼──────────┼──────────────────────┼───────────┼───────────────┼────────┼───────┤
│ 0 │ dev.local │ beer-sample │ couchbase │        2 │ none                 │ 412.0 MiB │ false         │        │ false │
│ 1 │ dev.local │ default     │ couchbase │        0 │ none                 │ 512.0 MiB │ false         │        │ false │
│ 2 │ dev.local │ memd        │ memcached │        0 │ none                 │ 100.0 MiB │ false         │        │ false │
╰───┴───────────┴─────────────┴───────────┴──────────┴──────────────────────┴───────────┴───────────────┴────────┴───────╯
```

As an advanced command, it is also possible to get the configuration for a bucket:
[options="nowrap"]
```
> buckets config default
╭────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────╮
│ authType               │ sasl                                                                                 │
│ autoCompactionSettings │ false                                                                                │
│ basicStats             │ {record 8 fields}                                                                    │
│ bucketCapabilities     │ [list 17 items]                                                                      │
│ bucketCapabilitiesVer  │                                                                                      │
│ bucketType             │ membase                                                                              │
│ collectionsManifestUid │ 21                                                                                   │
│ compressionMode        │ passive                                                                              │
│ conflictResolutionType │ seqno                                                                                │
│ controllers            │ {record 4 fields}                                                                    │
│ ddocs                  │ {record 1 field}                                                                     │
│ durabilityMinLevel     │ none                                                                                 │
│ evictionPolicy         │ valueOnly                                                                            │
│ localRandomKeyUri      │ /pools/default/buckets/default/localRandomKey                                        │
│ maxTTL                 │ 0                                                                                    │
│ name                   │ default                                                                              │
│ nodeLocator            │ vbucket                                                                              │
│ nodes                  │ [table 1 row]                                                                        │
│ numVBuckets            │ 64                                                                                   │
│ pitrEnabled            │ false                                                                                │
│ pitrGranularity        │ 600                                                                                  │
│ pitrMaxHistoryAge      │ 86400                                                                                │
│ quota                  │ {record 2 fields}                                                                    │
│ replicaIndex           │ false                                                                                │
│ replicaNumber          │ 0                                                                                    │
│ stats                  │ {record 3 fields}                                                                    │
│ storageBackend         │ couchstore                                                                           │
│ streamingUri           │ /pools/default/bucketsStreaming/default?bucket_uuid=0ef162c33e14b163630f04639b347937 │
│ threadsNumber          │ 3                                                                                    │
│ uri                    │ /pools/default/buckets/default?bucket_uuid=0ef162c33e14b163630f04639b347937          │
│ uuid                   │ 0ef162c33e14b163630f04639b347937                                                     │
│ vBucketServerMap       │ {record 4 fields}                                                                    │
╰────────────────────────┴──────────────────────────────────────────────────────────────────────────────────────╯
```

If you are unsure what you would use this for, you probably don't need it.

=== Working with `scopes` and `collections`

The `scopes` and `collections` commands can be used for managing scopes and collection respectively.

==== Scopes

```
> scopes -h
Fetches scopes through the HTTP API

Usage:
  > scopes {flags}

Subcommands:
  scopes create - Creates scopes through the HTTP API
  scopes drop - Deletes scopes through the HTTP API

Flags:
  -h, --help - Display the help message for this command
  --bucket <String> - the name of the bucket
  --clusters <String> - the clusters to query against
```

To list all scopes in the bucket you would use:

```
> scopes
╭───┬─────────────────┬───────────╮
│ # │      scope      │  cluster  │
├───┼─────────────────┼───────────┤
│ 0 │ inventory       │ dev.local │
│ 1 │ tenant_agent_00 │ dev.local │
│ 2 │ tenant_agent_01 │ dev.local │
│ 3 │ tenant_agent_02 │ dev.local │
│ 4 │ tenant_agent_03 │ dev.local │
│ 5 │ tenant_agent_04 │ dev.local │
│ 6 │ _default        │ dev.local │
╰───┴─────────────────┴───────────╯
```

You can also create and remove scopes:

```
> scopes create tenant_agent_05
> scopes
╭───┬─────────────────┬───────────╮
│ # │      scope      │  cluster  │
├───┼─────────────────┼───────────┤
│ 0 │ tenant_agent_05 │ dev.local │
│ 1 │ inventory       │ dev.local │
│ 2 │ tenant_agent_00 │ dev.local │
│ 3 │ tenant_agent_01 │ dev.local │
│ 4 │ tenant_agent_02 │ dev.local │
│ 5 │ tenant_agent_03 │ dev.local │
│ 6 │ tenant_agent_04 │ dev.local │
│ 7 │ _default        │ dev.local │
╰───┴─────────────────┴───────────╯
```

```
> scopes drop tenant_agent_05
> scopes
╭───┬─────────────────┬───────────╮
│ # │      scope      │  cluster  │
├───┼─────────────────┼───────────┤
│ 0 │ inventory       │ dev.local │
│ 1 │ tenant_agent_00 │ dev.local │
│ 2 │ tenant_agent_01 │ dev.local │
│ 3 │ tenant_agent_02 │ dev.local │
│ 4 │ tenant_agent_03 │ dev.local │
│ 5 │ tenant_agent_04 │ dev.local │
│ 6 │ _default        │ dev.local │
╰───┴─────────────────┴───────────╯
```

==== Collections

```
> collections -h
Fetches collections through the HTTP API

Usage:
  > collections {flags}

Subcommands:
  collections create - Creates collections through the HTTP API
  collections drop - Deletes collections through the HTTP API

Flags:
  -h, --help - Display the help message for this command
  --bucket <String> - the name of the bucket
  --scope <String> - the name of the scope
  --clusters <String> - the clusters to query against
```

To list all collection in the bucket you would use:

```
> collections
╭────┬─────────────────┬────────────┬────────────┬───────────╮
│  # │      scope      │ collection │ max_expiry │  cluster  │
├────┼─────────────────┼────────────┼────────────┼───────────┤
│  0 │ inventory       │ landmark   │       0sec │ dev.local │
│  1 │ inventory       │ hotel      │       0sec │ dev.local │
│  2 │ inventory       │ airport    │       0sec │ dev.local │
│  3 │ inventory       │ airline    │       0sec │ dev.local │
│  4 │ inventory       │ route      │       0sec │ dev.local │
│  5 │ tenant_agent_00 │ bookings   │       0sec │ dev.local │
│  6 │ tenant_agent_00 │ users      │       0sec │ dev.local │
│  7 │ tenant_agent_01 │ users      │       0sec │ dev.local │
│  8 │ tenant_agent_01 │ bookings   │       0sec │ dev.local │
│  9 │ tenant_agent_02 │ users      │       0sec │ dev.local │
│ 10 │ tenant_agent_02 │ bookings   │       0sec │ dev.local │
│ 11 │ tenant_agent_03 │ users      │       0sec │ dev.local │
│ 12 │ tenant_agent_03 │ bookings   │       0sec │ dev.local │
│ 13 │ tenant_agent_04 │ users      │       0sec │ dev.local │
│ 14 │ tenant_agent_04 │ bookings   │       0sec │ dev.local │
│ 15 │ _default        │ _default   │       0sec │ dev.local │
╰────┴─────────────────┴────────────┴────────────┴───────────╯
```

You can also create and remove collections:

```
> collections create staff --scope tenant_agent_00
> collections --scope tenant_agent_00
╭───┬─────────────────┬────────────┬────────────┬───────────╮
│ # │      scope      │ collection │ max_expiry │  cluster  │
├───┼─────────────────┼────────────┼────────────┼───────────┤
│ 0 │ tenant_agent_00 │ staff      │       0sec │ dev.local │
│ 1 │ tenant_agent_00 │ bookings   │       0sec │ dev.local │
│ 2 │ tenant_agent_00 │ users      │       0sec │ dev.local │
╰───┴─────────────────┴────────────┴────────────┴───────────╯
```

```
> collections drop staff --scope tenant_agent_00
> collections --scope tenant_agent_00
╭───┬─────────────────┬────────────┬────────────┬───────────╮
│ # │      scope      │ collection │ max_expiry │  cluster  │
├───┼─────────────────┼────────────┼────────────┼───────────┤
│ 0 │ tenant_agent_00 │ bookings   │       0sec │ dev.local │
│ 1 │ tenant_agent_00 │ users      │       0sec │ dev.local │
╰───┴─────────────────┴────────────┴────────────┴───────────╯
```

=== Listing `nodes`

The `nodes` command allows you to list all the nodes of the cluster you are currently connected to.

[options="nowrap"]
```
> nodes
╭───┬──────────────┬──────────────────────┬─────────┬──────────────────────────┬───────────────────────┬───────────────────────────┬──────────────┬─────────────┬─────────╮
│ # │   cluster    │       hostname       │ status  │         services         │        version        │            os             │ memory_total │ memory_free │ capella │
├───┼──────────────┼──────────────────────┼─────────┼──────────────────────────┼───────────────────────┼───────────────────────────┼──────────────┼─────────────┼─────────┤
│ 0 │ prod-us-west │ 192.168.107.128:8091 │ healthy │ search,indexing,kv,query │ 7.6.2-3505-enterprise │ aarch64-unknown-linux-gnu │   6201221120 │  2227081216 │ false   │
│ 1 │ prod-us-west │ 192.168.107.129:8091 │ healthy │ search,indexing,kv,query │ 7.6.2-3505-enterprise │ aarch64-unknown-linux-gnu │   6201221120 │  2204721152 │ false   │
│ 2 │ prod-us-west │ 192.168.107.130:8091 │ healthy │ search,indexing,kv,query │ 7.6.2-3505-enterprise │ aarch64-unknown-linux-gnu │   6201221120 │  2209816576 │ false   │
╰───┴──────────────┴──────────────────────┴─────────┴──────────────────────────┴───────────────────────┴───────────────────────────┴──────────────┴─────────────┴─────────╯
```

=== Reading and Writing `doc`uments

The fastest way to interact with documents is through the key value service (as long as you know the document ID).
All those commands are located as subcommands under the `doc` namespace.

==== Reading

You can retrieve a document with `doc get`:

```
> doc get airline_10
╭───┬────────────┬──────────────────────────────┬─────────────────────┬───────┬──────────────╮
│ # │     id     │           content            │         cas         │ error │   cluster    │
├───┼────────────┼──────────────────────────────┼─────────────────────┼───────┼──────────────┤
│ 0 │ airline_10 │ ╭──────────┬───────────────╮ │ 1712321628975398912 │       │ prod-us-west │
│   │            │ │ id       │ 10            │ │                     │       │              │
│   │            │ │ type     │ airline       │ │                     │       │              │
│   │            │ │ name     │ 40-Mile Air   │ │                     │       │              │
│   │            │ │ iata     │ Q5            │ │                     │       │              │
│   │            │ │ icao     │ MLA           │ │                     │       │              │
│   │            │ │ callsign │ MILE-AIR      │ │                     │       │              │
│   │            │ │ country  │ United States │ │                     │       │              │
│   │            │ ╰──────────┴───────────────╯ │                     │       │              │
╰───┴────────────┴──────────────────────────────┴─────────────────────┴───────┴──────────────╯
```

To distinguish the actual content from the metadata, the content is nested in the `content` field.
If you want to have everything at the toplevel, you can pipe to the `flatten` command:

[options="nowrap"]
```
> doc get airline_10 | flatten
╭───┬────────────┬────────────┬─────────┬─────────────┬──────┬──────┬──────────┬───────────────┬─────────────────────┬───────┬──────────────╮
│ # │     id     │ content_id │  type   │    name     │ iata │ icao │ callsign │    country    │         cas         │ error │   cluster    │
├───┼────────────┼────────────┼─────────┼─────────────┼──────┼──────┼──────────┼───────────────┼─────────────────────┼───────┼──────────────┤
│ 0 │ airline_10 │         10 │ airline │ 40-Mile Air │ Q5   │ MLA  │ MILE-AIR │ United States │ 1712321628975398912 │       │ prod-us-west │
╰───┴────────────┴────────────┴─────────┴─────────────┴──────┴──────┴──────────┴───────────────┴─────────────────────┴───────┴──────────────╯
```

If the document is not found, an empty result is returned.

To perform a bulk get operation, the incoming stream can be utilized.

```
> [airline_10 airline_10748 airline_137] | wrap id | doc get
╭───┬───────────────┬──────────────────────────────┬─────────────────────┬───────┬──────────────╮
│ # │      id       │           content            │         cas         │ error │   cluster    │
├───┼───────────────┼──────────────────────────────┼─────────────────────┼───────┼──────────────┤
│ 0 │ airline_10    │ ╭──────────┬───────────────╮ │ 1712321628975398912 │       │ prod-us-west │
│   │               │ │ id       │ 10            │ │                     │       │              │
│   │               │ │ type     │ airline       │ │                     │       │              │
│   │               │ │ name     │ 40-Mile Air   │ │                     │       │              │
│   │               │ │ iata     │ Q5            │ │                     │       │              │
│   │               │ │ icao     │ MLA           │ │                     │       │              │
│   │               │ │ callsign │ MILE-AIR      │ │                     │       │              │
│   │               │ │ country  │ United States │ │                     │       │              │
│   │               │ ╰──────────┴───────────────╯ │                     │       │              │
│ 1 │ airline_137   │ ╭──────────┬────────────╮    │ 1712321633323712512 │       │ prod-us-west │
│   │               │ │ id       │ 137        │    │                     │       │              │
│   │               │ │ type     │ airline    │    │                     │       │              │
│   │               │ │ name     │ Air France │    │                     │       │              │
│   │               │ │ iata     │ AF         │    │                     │       │              │
│   │               │ │ icao     │ AFR        │    │                     │       │              │
│   │               │ │ callsign │ AIRFRANS   │    │                     │       │              │
│   │               │ │ country  │ France     │    │                     │       │              │
│   │               │ ╰──────────┴────────────╯    │                     │       │              │
│ 2 │ airline_10748 │ ╭──────────┬───────────────╮ │ 1712321631323947008 │       │ prod-us-west │
│   │               │ │ id       │ 10748         │ │                     │       │              │
│   │               │ │ type     │ airline       │ │                     │       │              │
│   │               │ │ name     │ Locair        │ │                     │       │              │
│   │               │ │ iata     │ ZQ            │ │                     │       │              │
│   │               │ │ icao     │ LOC           │ │                     │       │              │
│   │               │ │ callsign │ LOCAIR        │ │                     │       │              │
│   │               │ │ country  │ United States │ │                     │       │              │
│   │               │ ╰──────────┴───────────────╯ │                     │       │              │
╰───┴───────────────┴──────────────────────────────┴─────────────────────┴───────┴──────────────╯
```

If `doc get` operates on an incoming stream it will extract the document id from the `id` column.
This behavior can be customized through the `--id-column` flag.

==== Mutating

Documents can be mutated with `doc insert`, `doc upsert` and `doc replace`.

All those three commands take similar arguments. If you only want to mutate a single document, passing in the ID and the content as arguments is the simplest way:

```
> doc upsert my-doc {"hello": "world"}
╭───┬───────────┬─────────┬────────┬──────────┬───────────╮
│ # │ processed │ success │ failed │ failures │  cluster  │
├───┼───────────┼─────────┼────────┼──────────┼───────────┤
│ 0 │         1 │       1 │      0 │          │ dev.local │
╰───┴───────────┴─────────┴────────┴──────────┴───────────╯
```

Multiple documents can be mutated through an input stream as well, defaulting to the `id` and `content` columns:

==== Removing

Documents can be removed with `doc remove`.

```
> doc remove airline_10
╭───┬───────────┬─────────┬────────┬──────────┬───────────╮
│ # │ processed │ success │ failed │ failures │  cluster  │
├───┼───────────┼─────────┼────────┼──────────┼───────────┤
│ 0 │         1 │       1 │      0 │          │ dev.local │
╰───┴───────────┴─────────┴────────┴──────────┴───────────╯
```

Similar to `doc get`, if you want to delete more than one document at the same time, provide a stream of ids with an `id` column:

```
> [airline_10 airline_10748 airline_137] | wrap id | doc remove
╭───┬───────────┬─────────┬────────┬───────────────┬───────────╮
│ # │ processed │ success │ failed │   failures    │  cluster  │
├───┼───────────┼─────────┼────────┼───────────────┼───────────┤
│ 0 │         3 │       2 │      1 │ Key not found │ dev.local │
╰───┴───────────┴─────────┴────────┴───────────────┴───────────╯
```

=== `subdoc get`
```
> subdoc get --help
Fetches the value of the provided path in the specified document through the data service

Usage:
  > subdoc get {flags} <path> (id)

Flags:
  -h, --help - Display the help message for this command
  --id-column <String> - the name of the id column if used with an input stream
  --bucket <String> - the name of the bucket
  --scope <String> - the name of the scope
  --collection <String> - the name of the collection
  --clusters <String> - the clusters which should be contacted
  --batch-size <Number> - the maximum number of items to batch send at a time
  -e, --halt-on-error - halt on any errors

Parameters:
  path <any>: the path(s) to be fetched from the documents
  id <string>: the document id (optional)
```

It can be used to retrieve a field from a single document:

```
👤 Administrator 🏠 cluster in 🗄 travel-sample._default._default
> subdoc get address landmark_10019
╭───┬────────────────┬─────────────────────────────┬─────────────────────┬───────┬─────────╮
│ # │       id       │           content           │         cas         │ error │ cluster │
├───┼────────────────┼─────────────────────────────┼─────────────────────┼───────┼─────────┤
│ 0 │ landmark_10019 │ Prince Arthur Road, ME4 4UG │ 1722410659053961216 │       │ local   │
╰───┴────────────────┴─────────────────────────────┴─────────────────────┴───────┴─────────╯
```

Or similarly to the `doc` commands a stream of ids can be provided:

```
👤 Administrator 🏠 cluster in 🗄 travel-sample._default._default
> [landmark_10019 landmark_10020] | subdoc get address
╭───┬────────────────┬─────────────────────────────┬─────────────────────┬───────┬─────────╮
│ # │       id       │           content           │         cas         │ error │ cluster │
├───┼────────────────┼─────────────────────────────┼─────────────────────┼───────┼─────────┤
│ 0 │ landmark_10019 │ Prince Arthur Road, ME4 4UG │ 1722410659053961216 │       │ local   │
│ 1 │ landmark_10020 │ 4 High Street, ME7 1BB      │ 1722410654151999488 │       │ local   │
╰───┴────────────────┴─────────────────────────────┴─────────────────────┴───────┴─────────╯
```

The path parameter can be a list, allowing retrieval of multiple fields in one or more docs:

```
👤 Administrator 🏠 cluster in 🗄 travel-sample._default._default
> [landmark_10019 landmark_10020] | subdoc get [name, address]
╭───┬────────────────┬───────────────────────────────────────────┬─────────────────────┬───────┬─────────╮
│ # │       id       │                  content                  │         cas         │ error │ cluster │
├───┼────────────────┼───────────────────────────────────────────┼─────────────────────┼───────┼─────────┤
│ 0 │ landmark_10019 │ ╭─────────┬─────────────────────────────╮ │ 1722410659053961216 │       │ local   │
│   │                │ │ name    │ Royal Engineers Museum      │ │                     │       │         │
│   │                │ │ address │ Prince Arthur Road, ME4 4UG │ │                     │       │         │
│   │                │ ╰─────────┴─────────────────────────────╯ │                     │       │         │
│ 1 │ landmark_10020 │ ╭─────────┬────────────────────────╮      │ 1722410654151999488 │       │ local   │
│   │                │ │ name    │ Hollywood Bowl         │      │                     │       │         │
│   │                │ │ address │ 4 High Street, ME7 1BB │      │                     │       │         │
│   │                │ ╰─────────┴────────────────────────╯      │                     │       │         │
╰───┴────────────────┴───────────────────────────────────────────┴─────────────────────┴───────┴─────────╯
```

=== `query` commands

```
> query --help
Performs a n1ql query

Usage:
  > query {flags} <statement>

Subcommands:
  query advise - Calls the query adviser and lists recommended indexes
  query indexes - Lists all query indexes
  query transactions - Performs a n1ql query as a part of a transaction

Flags:
  -h, --help - Display the help message for this command
  --clusters <String> - the clusters to query against
  --bucket <String> - the bucket to query against
  --scope <String> - the scope to query against
  --params <Any> - named or positional parameters for the query
  --with-meta - include toplevel metadata
  --disable-context - disable automatically detecting the query context based on the active bucket and scope

Parameters:
  statement <string>: the query statement
```

The query commands can be used to explore/create indexes and execute queries.

==== `query`

The plain `query` command takes a n1ql statement and executes it against the active cluster. For example the following
gets the IDs of the landmark docs where the country is France:

```
👤 Administrator 🏠 cluster in 🗄 travel-sample._default._default
> query "SELECT meta().id FROM `travel-sample`.inventory.landmark WHERE country = 'France'"
╭─────┬────────────────┬─────────╮
│   # │       id       │ cluster │
├─────┼────────────────┼─────────┤
│   0 │ landmark_10061 │ local   │
│ ... │       ...      │   ...   │
│ 387 │ landmark_9838  │ local   │
╰─────┴────────────────┴─────────╯
```

Named query parameters can be used by passing them in with the `--params` flag:

```
👤 Administrator 🏠 cluster in 🗄 travel-sample._default._default
> query "SELECT meta().id FROM `travel-sample`.inventory.landmark WHERE country = $country" --params {country: France}
╭─────┬────────────────┬─────────╮
│   # │       id       │ cluster │
├─────┼────────────────┼─────────┤
│   0 │ landmark_10061 │ local   │
│ ... │       ...      │   ...   │
│ 387 │ landmark_9838  │ local   │
╰─────┴────────────────┴─────────╯
```

Multiple named parameters can be used at once, note there is no need to seperate them with commas:

```
👤 Administrator 🏠 cluster in 🗄 travel-sample._default._default
> query "SELECT airline FROM `travel-sample`.inventory.route WHERE sourceairport = $aval AND distance > $dval" --params {aval: LAX dval: 13000}
╭───┬─────────┬─────────╮
│ # │ airline │ cluster │
├───┼─────────┼─────────┤
│ 0 │ B6      │ local   │
│ 1 │ EK      │ local   │
│ 2 │ SV      │ local   │
╰───┴─────────┴─────────╯
```

The wildcard character '%' can be used the same as inside of the query statement. The following finds any IDs
that match the regex 'hotel1002*'.

```
👤 Administrator 🏠 cluster in 🗄 travel-sample._default._default
> query "SELECT meta().id FROM `travel-sample`.inventory.hotel WHERE meta().id LIKE $pattern" --params {pattern: hotel_1002%}
╭───┬─────────────┬─────────╮
│ # │     id      │ cluster │
├───┼─────────────┼─────────┤
│ 0 │ hotel_10025 │ local   │
│ 1 │ hotel_10026 │ local   │
╰───┴─────────────┴─────────╯
```

==== `query advise`

```
> query advise --help
Calls the query adviser and lists recommended indexes

Usage:
  > query advise {flags} <statement>

Flags:
  -h, --help - Display the help message for this command
  --with-meta - Includes related metadata in the result
  --disable-context - disable automatically detecting the query context based on the active bucket and scope
  --clusters <String> - the clusters to query against

Parameters:
  statement <string>: the query statement
```

The query advise command can help you to learn about the indexes that your queries are using, and what indexes
you could create to make them faster. For example we can take the first query from the `query` examples:

[options="nowrap"]
```
> query advise "SELECT meta().id FROM `travel-sample`.inventory.landmark WHERE country = 'France'"
╭───┬───────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────╮
│ # │ #operator │                                                                                                           advice                                                                                                            │ ... │
├───┼───────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┼─────┤
│ 0 │ Advise    │ ╭────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ │ ... │
│   │           │ │ #operator  │ IndexAdvice                                                                                                                                                                                                │ │     │
│   │           │ │            │ ╭─────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ │ │     │
│   │           │ │ adviseinfo │ │                     │ ╭───┬─────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────────╮                                                 │ │ │     │
│   │           │ │            │ │ current_indexes     │ │ # │                                             index_statement                                             │ keyspace_alias │                                                 │ │ │     │
│   │           │ │            │ │                     │ ├───┼─────────────────────────────────────────────────────────────────────────────────────────────────────────┼────────────────┤                                                 │ │ │     │
│   │           │ │            │ │                     │ │ 0 │ CREATE PRIMARY INDEX def_inventory_landmark_primary ON `default`:`travel-sample`.`inventory`.`landmark` │ landmark       │                                                 │ │ │     │
│   │           │ │            │ │                     │ ╰───┴─────────────────────────────────────────────────────────────────────────────────────────────────────────┴────────────────╯                                                 │ │ │     │
│   │           │ │            │ │                     │ ╭──────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ │ │ │     │
│   │           │ │            │ │ recommended_indexes │ │                  │ ╭───┬─────────────────────────────────────────────────────────────────────────────────────────┬────────────────╮                                          │ │ │ │     │
│   │           │ │            │ │                     │ │ covering_indexes │ │ # │                                     index_statement                                     │ keyspace_alias │                                          │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ ├───┼─────────────────────────────────────────────────────────────────────────────────────────┼────────────────┤                                          │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ │ 0 │ CREATE INDEX adv_country ON `default`:`travel-sample`.`inventory`.`landmark`(`country`) │ landmark       │                                          │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ ╰───┴─────────────────────────────────────────────────────────────────────────────────────────┴────────────────╯                                          │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ ╭───┬─────────────────────────────────────────────────────────────────────────────────────────┬────────────────┬────────────────────────────────────────╮ │ │ │ │     │
│   │           │ │            │ │                     │ │ indexes          │ │ # │                                     index_statement                                     │ keyspace_alias │           recommending_rule            │ │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ ├───┼─────────────────────────────────────────────────────────────────────────────────────────┼────────────────┼────────────────────────────────────────┤ │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ │ 0 │ CREATE INDEX adv_country ON `default`:`travel-sample`.`inventory`.`landmark`(`country`) │ landmark       │ Index keys follow order of predicate   │ │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ │   │                                                                                         │                │ types: 2. equality/null/missing.       │ │ │ │ │     │
│   │           │ │            │ │                     │ │                  │ ╰───┴─────────────────────────────────────────────────────────────────────────────────────────┴────────────────┴────────────────────────────────────────╯ │ │ │ │     │
│   │           │ │            │ │                     │ ╰──────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │ │ │     │
│   │           │ │            │ ╰─────────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │ │     │
│   │           │ ╰────────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │     │
╰───┴───────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴─────╯
```

Here we can see that currently our statement uses the Primary index `def_inventory_landmark_primary` but it also
recommends a covering index that we can create. We can use the `query` command to create the new suggested index as follows:

```
query "CREATE INDEX adv_country ON `default`:`travel-sample`.`inventory`.`landmark`(`country`)"
```

==== `query indexes`
```
> query indexes --help
Lists all query indexes

Usage:
  > query indexes {flags}

Flags:
  -h, --help - Display the help message for this command
  --definitions - Whether to fetch the index definitions (changes the output format)
  --clusters <String> - the clusters to query against
  --with-meta - Includes related metadata in the result
  --disable-context - disable automatically detecting the query context based on the active bucket and scope
```

`query indexes` is very useful for managing and exploring indexes. If we had just created the recommended index at the
end of the `query advise` section, the nushell command `find` can be used in conjunction with `query indexes` to check
it was successfully created.

[options="nowrap"]
```
> query indexes | find adv_country
╭───┬───────────────┬───────────┬───────────────────┬──────────┬─────────────┬─────────┬───────────┬────────┬──────┬─────────╮
│ # │    bucket     │ condition │     index_key     │ keyspace │    name     │ primary │   scope   │ state  │ type │ cluster │
├───┼───────────────┼───────────┼───────────────────┼──────────┼─────────────┼─────────┼───────────┼────────┼──────┼─────────┤
│ 0 │ travel-sample │           │ ╭───┬───────────╮ │ landmark │ adv_country │ false   │ inventory │ online │ gsi  │ local   │
│   │               │           │ │ 0 │ `country` │ │          │             │         │           │        │      │         │
│   │               │           │ ╰───┴───────────╯ │          │             │         │           │        │      │         │
╰───┴───────────────┴───────────┴───────────────────┴──────────┴─────────────┴─────────┴───────────┴────────┴──────┴─────────╯
```

And if we want to check the definition this can be done using the `--definitions` flag:

[options="nowrap"]
```
> query indexes --definitions | find adv_country
╭───┬───────────────┬───────────┬────────────┬─────────────┬────────┬──────────────┬──────────┬─────────────────────────────────────────────────────────────────────────────────┬─────────╮
│ # │    bucket     │   scope   │ collection │    name     │ status │ storage_mode │ replicas │                                   definition                                    │ cluster │
├───┼───────────────┼───────────┼────────────┼─────────────┼────────┼──────────────┼──────────┼─────────────────────────────────────────────────────────────────────────────────┼─────────┤
│ 0 │ travel-sample │ inventory │ landmark   │ adv_country │ Ready  │ plasma       │        0 │ CREATE INDEX `adv_country` ON `travel-sample`.`inventory`.`landmark`(`country`) │ local   │
╰───┴───────────────┴───────────┴────────────┴─────────────┴────────┴──────────────┴──────────┴─────────────────────────────────────────────────────────────────────────────────┴─────────╯
```

=== `vector` commands

```
> vector --help
Commands that support and implement vector search

Usage:
  > vector

Subcommands:
  vector create-index - Creates a vector index
  vector enrich-doc - Enriches given JSON with embeddings of selected field
  vector enrich-text - Generates embeddings from text using the active llm
  vector search - Performs a vector search query

Flags:
  -h, --help - Display the help message for this comma
```

The vector commands make it easy to explore the value that vector search can add to your data.

==== `vector search`

```
> vector search --help
Performs a vector search query

Usage:
  > vector search {flags} <index> <field> (vector)

Flags:
  -h, --help - Display the help message for this command
  --query <String> - the text to query for using a query string query
  --clusters <String> - the clusters which should be contacted
  --neighbors <Int> - number of neighbors returned by vector search (default = 3)
  --bucket <String> - the name of the bucket
  --scope <String> - the name of the scope

Parameters:
  index <string>: the index name
  field <string>: name of the vector field the index was built on
  vector <list<float>>: the vector used for searching (optional)
```

Performs a vector search against a named vector index.
Requires a vector to be used as the source of the search which can be supplied in a couple of formats.

For example imagine we have the following document stored in our cluster:

[options="nowrap"]
```
> doc get 10019
╭───┬───────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────╮
│ # │  id   │                                                                                                            content                                                                                                            │ ... │
├───┼───────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┼─────┤
│ 0 │ 10019 │ ╭───────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ │ ... │
│   │       │ │ title         │ Gillingham (Kent)                                                                                                                                                                                         │ │     │
│   │       │ │ name          │ Royal Engineers Museum                                                                                                                                                                                    │ │     │
│   │       │ │ alt           │                                                                                                                                                                                                           │ │     │
│   │       │ │ address       │ Prince Arthur Road, ME4 4UG                                                                                                                                                                               │ │     │
│   │       │ │ directions    │                                                                                                                                                                                                           │ │     │
│   │       │ │ phone         │ +44 1634 822839                                                                                                                                                                                           │ │     │
│   │       │ │ tollfree      │                                                                                                                                                                                                           │ │     │
│   │       │ │ email         │                                                                                                                                                                                                           │ │     │
│   │       │ │ url           │ http://www.remuseum.org.uk                                                                                                                                                                                │ │     │
│   │       │ │ hours         │ Tues - Fri 9.00am to 5.00pm, Sat - Sun 11.30am - 5.00pm                                                                                                                                                   │ │     │
│   │       │ │ image         │                                                                                                                                                                                                           │ │     │
│   │       │ │ price         │                                                                                                                                                                                                           │ │     │
│   │       │ │ content       │ Adult - £6.99 for an Adult ticket that allows you to come back for further visits within a year (children's and concessionary tickets also available). Museum on military engineering and the history of  │ │     │
│   │       │ │               │ the British Empire. A quite extensive collection that takes about half a day to see. Of most interest to fans of British and military history or civil engineering. The outside collection of tank        │ │     │
│   │       │ │               │ mounted bridges etc can be seen for free. There is also an extensive series of themed special event weekends, admission to which is included in the cost of the annual ticket.                            │ │     │
│   │       │ │               │ ╭──────────┬────────────────────╮                                                                                                                                                                         │ │     │
│   │       │ │ geo           │ │ lat      │ 51.39              │                                                                                                                                                                         │ │     │
│   │       │ │               │ │ lon      │ 0.54               │                                                                                                                                                                         │ │     │
│   │       │ │               │ │ accuracy │ RANGE_INTERPOLATED │                                                                                                                                                                         │ │     │
│   │       │ │               │ ╰──────────┴────────────────────╯                                                                                                                                                                         │ │     │
│   │       │ │ activity      │ see                                                                                                                                                                                                       │ │     │
│   │       │ │ type          │ landmark                                                                                                                                                                                                  │ │     │
│   │       │ │ id            │ 10019                                                                                                                                                                                                     │ │     │
│   │       │ │ country       │ United Kingdom                                                                                                                                                                                            │ │     │
│   │       │ │ city          │ Gillingham                                                                                                                                                                                                │ │     │
│   │       │ │ state         │                                                                                                                                                                                                           │ │     │
│   │       │ │               │ ╭──────┬───────╮                                                                                                                                                                                          │ │     │
│   │       │ │ contentVector │ │    0 │  0.03 │                                                                                                                                                                                          │ │     │
│   │       │ │               │ │  ... │  ...  │                                                                                                                                                                                          │ │     │
│   │       │ │               │ │ 1023 │ -0.00 │                                                                                                                                                                                          │ │     │
│   │       │ │               │ ╰──────┴───────╯                                                                                                                                                                                          │ │     │
│   │       │ ╰───────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │     │
╰───┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴─────╯
```

The field `contentVector` contains a vector of dimension 1024 that could be used as the input to a vector search.
Due to the format of the data returned by <<_reading, doc get>> we need to https://www.nushell.sh/commands/docs/flatten.html[flatten] to remove the nesting then https://www.nushell.sh/commands/docs/select.html[select] the `contentVector` field:

```
> doc get 10019 | flatten | select contentVector
╭───┬──────────────────╮
│ # │  contentVector   │
├───┼──────────────────┤
│ 0 │ ╭──────┬───────╮ │
│   │ │    0 │  0.03 │ │
│   │ │ ...  │  ...  │ │
│   │ │ 1023 │ -0.00 │ │
│   │ ╰──────┴───────╯ │
╰───┴──────────────────╯
```

This can then be piped directly into `vector search`:

```
> doc get 10019 | flatten | select contentVector  | vector search landmark-content-index contentVector
╭───┬───────┬─────────────────────────────────────────┬─────────╮
│ # │  id   │                  score                  │ cluster │
├───┼───────┼─────────────────────────────────────────┼─────────┤
│ 0 │ 10019 │ 340282350000000000000000000000000000000 │ local   │
│ 1 │ 16379 │ 1.0082568                               │ local   │
│ 2 │ 33857 │ 0.9897698                               │ local   │
╰───┴───────┴─────────────────────────────────────────┴─────────╯
```

We specify `contentVector` as the final positional parameter to `vector search` NOT because this is the name of the field that we got our vector from, but because this is name of the field on which the index was created.
See <<_vector_create_index,vector create-index>> for further explanation.

<<_subdoc_get, Subdoc get>> can also be used to fetch the source vector:

```
> subdoc get contentVector 10019 | select content | vector search landmark-content-index contentVector
╭───┬───────┬─────────────────────────────────────────┬─────────╮
│ # │  id   │                  score                  │ cluster │
├───┼───────┼─────────────────────────────────────────┼─────────┤
│ 0 │ 10019 │ 340282350000000000000000000000000000000 │ local   │
│ 1 │ 16379 │ 1.0082568                               │ local   │
│ 2 │ 33857 │ 0.9897698                               │ local   │
╰───┴───────┴─────────────────────────────────────────┴─────────╯
```

Here we don't need to flatten and specify the field since the content of the `sub doc` output already only holds the `contentVector` field.

Another format that is accepted is the output of  <<_vector_enrich_text,vector enrich-text>> :

```
> vector enrich-text "some string" --dimension 1024 | vector search landmark-content-index contentVector
Embedding batch 1/1
╭───┬───────┬────────────┬─────────╮
│ # │  id   │   score    │ cluster │
├───┼───────┼────────────┼─────────┤
│ 0 │ 21681 │ 0.7402005  │ local   │
│ 1 │ 21682 │ 0.73517126 │ local   │
│ 2 │ 6073  │ 0.70910853 │ local   │
╰───┴───────┴────────────┴─────────╯
```

Note the `--dimension` flag used here, the vector provided as the source of the search must match the dimension of the vectors on which the index was <<_vector_create_index,created>> else you will get no results.

Finally if you just have a plain vector that is a list of floats this can be passed in as a final positional parameter:

```
> let vector = [0.1 0.2 0.3 0.4]
> vector search vector-index fieldName $vector
```

The vector here only has a dimension of 4 which is unrealistically low, but it is used for illustrative purposes.

The output of the search is a table containing the IDs of the `n` (specified by the `--neighbours` flag) documents with the most similar vector in the field named.
The similarity of vectors is calculated using the metric specified on <<_vector_create_index,index creation>>.

To see the contents of the documents identified in the table simply pipe the output of vector search into a <<_reading,doc get>> command.
If only interested in a particular field then the <<_subdoc_get,subdoc get>> command will also work in the same way:

```
👤 Administrator 🏠 local in ☁️ default._default._default
> vector search landmark-content-index contentVector $vector | subdoc get address
╭───┬───────┬───────────────────────────────────────┬─────────────────────┬───────┬─────────╮
│ # │  id   │                content                │         cas         │ error │ cluster │
├───┼───────┼───────────────────────────────────────┼─────────────────────┼───────┼─────────┤
│ 0 │ 11956 │ Hornchurch Road, Hornchurch, RM11 1JU │ 1722871671832641536 │       │ local   │
│ 1 │ 25284 │ 4040 Twiggs St                        │ 1722871685304025088 │       │ local   │
│ 2 │ 7744  │ Grandstand Road                       │ 1722871709487202304 │       │ local   │
╰───┴───────┴───────────────────────────────────────┴─────────────────────┴───────┴─────────╯
```

The environment is important when using the `vector search` command as the fully qualified index name is constructed from the active bucket and scope.
The above command will be trying to use the index `default._default.landmark-content-index`.
If the index was created against a different bucket/scope then you will get an index not found error.

[options="nowrap"]
```
👤 Charlie 🏠 local in 🗄 travel-sample.inventory._default
> vector search landmark-content-index contentVector $vector
Error:   × Unexpected status code
   ╭─[entry #4:1:1]
 1 │ vector search landmark-content-index contentVector $vector
   · ──────┬──────
   ·       ╰──
   ╰────
  help: Unexpected status code: 400, body: {"error":"rest_auth: preparePerms, err: index not found","request":{"ctl":{"timeout":75000},"knn":[{"field":"contentVector","k":3,"vector":
  ...
```

If you want to use an index that was created against a different bucket/scope to those that are active, this can be done with the `--bucket` and `--scope` flags.

```
👤 Charlie 🏠 local in 🗄 travel-sample.inventory._default
> vector search landmark-content-index contentVector $vector --bucket default --scope _default
╭───┬───────┬─────────────────────────────────────────┬─────────╮
│ # │  id   │                  score                  │ cluster │
├───┼───────┼─────────────────────────────────────────┼─────────┤
│ 0 │ 10019 │ 340282350000000000000000000000000000000 │ local   │
│ 1 │ 16379 │ 1.0082568                               │ local   │
│ 2 │ 33857 │ 0.9897698                               │ local   │
╰───┴───────┴─────────────────────────────────────────┴─────────╯
```

==== `vector create-index`

```
> vector create-index --help
Creates a vector index

Usage:
  > vector create-index {flags} <name> <field> <dimension>

Flags:
  -h, --help - Display the help message for this command
  --similarity-metric <String> - metric used to calculate vector similarity - defaults to l2_norm
  --clusters <String> - the clusters which should be contacted
  --bucket <String> - the name of the bucket
  --scope <String> - the name of the scope
  --collection <String> - the name of the collection

Parameters:
  name <string>: the index name
  field <string>: name of the vector field to build the index on
  dimension <int>: the dimension of the vectors the index will be built on
```

Creates a vector index against the active bucket/scope or the bucket/scope specified with the corresponding flags.
For example the following will create an index over documents in the bucket `default` and the scope `_default`:

```
👤 Administrator 🏠 remote in ☁️ default._default._default
> vector create-index new-vector-index fieldName 1024
```

Any documents located elsewhere will not be indexed, and a vector search performed with this index will not find them.
If the documents to be indexed were stored elsewhere then the environment would need to be changed with `cb-env bucket/scope` or the bucket and scope could be passed in with the appropriate flags.

The field parameter is the name of the field in the documents that contains the vector, and the dimension (length of the vector) parameter must match that of the vectors contained in the named field.
Imagine there are documents with the following structure in the bucket `users` and scope `embeddedUsers`:

```
{
    "name": "my-name",
    "e-mail": "shell-user@couchbase.com",
    "description": "A rich textual description of the user.",
    "descriptionEmbedding": [0.0178287, 0.123098, -0.0189239, 1.109238],
}
```

In this example the descriptionEmbedding is the result of using a large language model to generate an embedding from the description field.
The dimension of the vector (4) is unrealistically low but it's been chosen for illustrative purposes.
To create an index over such documents in order to find users with similar descriptions the command would be:

```
👤 Administrator 🏠 remote in ☁️ users.embeddedUsers._default
> vector create-index user-description-index descriptionEmbedding 4

or

👤 Administrator 🏠 remote in ☁️ default._default._default
> vector create-index user-description-index descriptionEmbedding 4 --bucket users --scope embeddedUsers
```

In the first example the create command is run from within the bucket and scope that the documents are stored in.
Whereas in the latter the environment values need to be overwritten with the `--bucket` and `--scope` flags to correctly create the index.

==== `vector enrich-doc`

```
> vector enrich-doc --help
Enriches given JSON with embeddings of selected field

Usage:
  > vector enrich-doc {flags} <field>

Flags:
  -h, --help - Display the help message for this command
  --model <String> - the model to generate the embeddings with
  --dimension <Int> - dimension of the resulting embeddings
  --maxTokens <Int> - the token per minute limit for the provider/model
  --id-column <String> - the name of the id column if used with an input stream
  --vectorField <String> - the name of the field into which the embedding is written, defaults to fieldVector

Parameters:
  field <string>: the field from which the vector is generated
```

This command "enriches" an existing json document by generating an embedding using the <<_cb_env_llm,active llm>> from a named field and storing it in a new field in the same document.

For example take one of the documents from the travel sample data set:

[options="nowrap"]
```
> doc get landmark_10019
╭───┬────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────╮
│ # │       id       │                                                                                                        content                                                                                                         │ ... │
├───┼────────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┼─────┤
│ 0 │ landmark_10019 │ ╭────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ │ ... │
│   │                │ │ title      │ Gillingham (Kent)                                                                                                                                                                                     │ │     │
│   │                │ │ name       │ Royal Engineers Museum                                                                                                                                                                                │ │     │
│   │                │ │ alt        │                                                                                                                                                                                                       │ │     │
│   │                │ │ address    │ Prince Arthur Road, ME4 4UG                                                                                                                                                                           │ │     │
│   │                │ │ directions │                                                                                                                                                                                                       │ │     │
│   │                │ │ phone      │ +44 1634 822839                                                                                                                                                                                       │ │     │
│   │                │ │ tollfree   │                                                                                                                                                                                                       │ │     │
│   │                │ │ email      │                                                                                                                                                                                                       │ │     │
│   │                │ │ url        │ http://www.remuseum.org.uk                                                                                                                                                                            │ │     │
│   │                │ │ hours      │ Tues - Fri 9.00am to 5.00pm, Sat - Sun 11.30am - 5.00pm                                                                                                                                               │ │     │
│   │                │ │ image      │                                                                                                                                                                                                       │ │     │
│   │                │ │ price      │                                                                                                                                                                                                       │ │     │
│   │                │ │ content    │ Adult - £6.99 for an Adult ticket that allows you to come back for further visits within a year (children's and concessionary tickets also available). Museum on military engineering and the history │ │     │
│   │                │ │            │  of the British Empire. A quite extensive collection that takes about half a day to see. Of most interest to fans of British and military history or civil engineering. The outside collection of     │ │     │
│   │                │ │            │ tank mounted bridges etc can be seen for free. There is also an extensive series of themed special event weekends, admission to which is included in the cost of the annual ticket.                   │ │     │
│   │                │ │            │ ╭──────────┬────────────────────╮                                                                                                                                                                     │ │     │
│   │                │ │ geo        │ │ lat      │ 51.39              │                                                                                                                                                                     │ │     │
│   │                │ │            │ │ lon      │ 0.54               │                                                                                                                                                                     │ │     │
│   │                │ │            │ │ accuracy │ RANGE_INTERPOLATED │                                                                                                                                                                     │ │     │
│   │                │ │            │ ╰──────────┴────────────────────╯                                                                                                                                                                     │ │     │
│   │                │ │ activity   │ see                                                                                                                                                                                                   │ │     │
│   │                │ │ type       │ landmark                                                                                                                                                                                              │ │     │
│   │                │ │ id         │ 10019                                                                                                                                                                                                 │ │     │
│   │                │ │ country    │ United Kingdom                                                                                                                                                                                        │ │     │
│   │                │ │ city       │ Gillingham                                                                                                                                                                                            │ │     │
│   │                │ │ state      │                                                                                                                                                                                                       │ │     │
│   │                │ ╰────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │     │
╰───┴────────────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴─────╯
```

We can use the content field to generate an embedding, and the result will be a new document that is the same as the original, with a new field containing the vector that is the result of the embedding:

[options="nowrap"]
```
> doc get landmark_10019 | select content | vector enrich-doc content
Embedding batch 1/1
╭───┬───────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ # │  id   │                                                                                                                content                                                                                                                │
├───┼───────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 0 │ 10019 │ ╭───────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ │
│   │       │ │ title         │ Gillingham (Kent)                                                                                                                                                                                                 │ │
│   │       │ │ name          │ Royal Engineers Museum                                                                                                                                                                                            │ │
│   │       │ │ alt           │                                                                                                                                                                                                                   │ │
│   │       │ │ address       │ Prince Arthur Road, ME4 4UG                                                                                                                                                                                       │ │
│   │       │ │ directions    │                                                                                                                                                                                                                   │ │
│   │       │ │ phone         │ +44 1634 822839                                                                                                                                                                                                   │ │
│   │       │ │ tollfree      │                                                                                                                                                                                                                   │ │
│   │       │ │ email         │                                                                                                                                                                                                                   │ │
│   │       │ │ url           │ http://www.remuseum.org.uk                                                                                                                                                                                        │ │
│   │       │ │ hours         │ Tues - Fri 9.00am to 5.00pm, Sat - Sun 11.30am - 5.00pm                                                                                                                                                           │ │
│   │       │ │ image         │                                                                                                                                                                                                                   │ │
│   │       │ │ price         │                                                                                                                                                                                                                   │ │
│   │       │ │ content       │ Adult - £6.99 for an Adult ticket that allows you to come back for further visits within a year (children's and concessionary tickets also available). Museum on military engineering and the history of the      │ │
│   │       │ │               │ British Empire. A quite extensive collection that takes about half a day to see. Of most interest to fans of British and military history or civil engineering. The outside collection of tank mounted bridges    │ │
│   │       │ │               │ etc can be seen for free. There is also an extensive series of themed special event weekends, admission to which is included in the cost of the annual ticket.                                                    │ │
│   │       │ │               │ ╭──────────┬────────────────────╮                                                                                                                                                                                 │ │
│   │       │ │ geo           │ │ lat      │ 51.39              │                                                                                                                                                                                 │ │
│   │       │ │               │ │ lon      │ 0.54               │                                                                                                                                                                                 │ │
│   │       │ │               │ │ accuracy │ RANGE_INTERPOLATED │                                                                                                                                                                                 │ │
│   │       │ │               │ ╰──────────┴────────────────────╯                                                                                                                                                                                 │ │
│   │       │ │ activity      │ see                                                                                                                                                                                                               │ │
│   │       │ │ type          │ landmark                                                                                                                                                                                                          │ │
│   │       │ │ id            │ 10019                                                                                                                                                                                                             │ │
│   │       │ │ country       │ United Kingdom                                                                                                                                                                                                    │ │
│   │       │ │ city          │ Gillingham                                                                                                                                                                                                        │ │
│   │       │ │ state         │                                                                                                                                                                                                                   │ │
│   │       │ │               │ ╭──────┬───────╮                                                                                                                                                                                                  │ │
│   │       │ │ contentVector │ │    0 │  0.02 │                                                                                                                                                                                                  │ │
│   │       │ │               │ │  ... │   ... │                                                                                                                                                                                                  │ │
│   │       │ │               │ │ 1535 │ -0.01 │                                                                                                                                                                                                  │ │
│   │       │ │               │ ╰──────┴───────╯                                                                                                                                                                                                  │ │
│   │       │ ╰───────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
╰───┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
```

The resulting document is the same as the original, but with a new field `contentVector` which contains the result of embedding the content field with the <<_cb_env_llm,active llm>>.
The name of the field that the embedding will be written to will default to the name of the original field with "Vector" appended.
This default behaviour can be overwritten with the `vectorField` flag.
The resulting document is formatted with an id and content column which allows it to be piped into a `doc upsert` command to store it in the connected couchbase cluster.

```
> doc get landmark_10019 | select content | vector enrich-doc content | doc upsert
Embedding batch 1/1
╭───┬───────────┬─────────┬────────┬──────────┬─────────╮
│ # │ processed │ success │ failed │ failures │ cluster │
├───┼───────────┼─────────┼────────┼──────────┼─────────┤
│ 0 │         1 │       1 │      0 │          │ local   │
╰───┴───────────┴─────────┴────────┴──────────┴─────────╯
```

`vector enrich-doc` can enrich more than one document at a time.
To repeat what we have done above on all the landmark documents we can get all the docs using a query and pipe the result directly into the `enrich-doc` command:

```
> query "SELECT * FROM `travel-sample` WHERE type = 'landmark'" | vector enrich-doc content
```

==== `vector enrich-text`

```
> vector enrich-text --help
Generates embeddings from text using the active llm

Usage:
  > vector enrich-text {flags} (text)

Flags:
  -h, --help - Display the help message for this command
  --model <String> - the model to generate the embeddings with
  --chunk <Int> - length of the data chunks to embed (default 1024)
  --dimension <Int> - dimension of the resulting embeddings
  --maxTokens <Int> - the token per minute limit for the provider/model

Parameters:
  text <string>: the text to be embedded (optional)
```

This command generates and embedding from the input using the <<_cb_env_llm,active_llm>> text and outputs a json document containing the source text and the embedding.

It can be used directly on strings, which can be passed in as a positional parameter:

```
> vector enrich-text "some string" --dimension 5
Embedding batch 1/1
╭───┬───────────────┬────────────────────────────╮
│ # │      id       │          content           │
├───┼───────────────┼────────────────────────────┤
│ 0 │ vector-c9e02c │ ╭────────┬───────────────╮ │
│   │               │ │ text   │ some string   │ │
│   │               │ │        │ ╭───┬───────╮ │ │
│   │               │ │ vector │ │ 0 │  0.31 │ │ │
│   │               │ │        │ │ 1 │ -0.61 │ │ │
│   │               │ │        │ │ 2 │ -0.21 │ │ │
│   │               │ │        │ │ 3 │ -0.59 │ │ │
│   │               │ │        │ │ 4 │ -0.38 │ │ │
│   │               │ │        │ ╰───┴───────╯ │ │
│   │               │ ╰────────┴───────────────╯ │
╰───┴───────────────┴────────────────────────────╯
```

Or piped directly in:

```
> "some string" | vector enrich-text --dimension 5
Embedding batch 1/1
╭───┬───────────────┬────────────────────────────╮
│ # │      id       │          content           │
├───┼───────────────┼────────────────────────────┤
│ 0 │ vector-a269a7 │ ╭────────┬───────────────╮ │
│   │               │ │ text   │ some string   │ │
│   │               │ │        │ ╭───┬───────╮ │ │
│   │               │ │ vector │ │ 0 │  0.31 │ │ │
│   │               │ │        │ │ 1 │ -0.61 │ │ │
│   │               │ │        │ │ 2 │ -0.21 │ │ │
│   │               │ │        │ │ 3 │ -0.59 │ │ │
│   │               │ │        │ │ 4 │ -0.38 │ │ │
│   │               │ │        │ ╰───┴───────╯ │ │
│   │               │ ╰────────┴───────────────╯ │
╰───┴───────────────┴────────────────────────────╯
```

Note that the dimension used here (5) is unrealistically low, but has just been chosen for illustrative purposes.

The output is in a format that means it can be piped directly into a `doc upsert` command to upsert it into the cluster:

```
> "some string" | vector enrich-text --dimension 5 | doc upsert
Embedding batch 1/1
╭───┬───────────┬─────────┬────────┬──────────┬─────────╮
│ # │ processed │ success │ failed │ failures │ cluster │
├───┼───────────┼─────────┼────────┼──────────┼─────────┤
│ 0 │         1 │       1 │      0 │          │ local   │
╰───┴───────────┴─────────┴────────┴──────────┴─────────╯
```

Or the output can be piped directly into `vector search` to find indexed docs with a similar vector.
This makes `vector enrich-text` a very easy way to experiment with similarity search using strings.
See <<_vector_search,vector search>> for an example of this.

`vector enrich-text` can also be used on larger chunks of text to produce multiple `vector docs` at once.
For example say you have a text file called `some-text.txt`:

```
> open some-text.txt | vector enrich-text | doc upsert
Embedding batch 1/1
╭───┬───────────┬─────────┬────────┬──────────┬─────────╮
│ # │ processed │ success │ failed │ failures │ cluster │
├───┼───────────┼─────────┼────────┼──────────┼─────────┤
│ 0 │        92 │      92 │      0 │          │ local   │
╰───┴───────────┴─────────┴────────┴──────────┴─────────╯
```

When used on larger amounts of text `vector enrich-text` will split it into chunks of length 1024 by default, the length of the chunks can be changed with the `--chunks` flag.
In this example the contents of `some-text.txt` was split into 92 chunks, resulting in 92 `vector docs` that were then upserted into the connected cluster.

Finally if you have a set of files within a directory that you want to generate `vector docs` from then you can list the files in the current directory with `ls` and pipe this list into `vector enrich-text`:

```
> ls | vector enrich-text | doc upsert
Embedding batch 1/1
╭───┬───────────┬─────────┬────────┬──────────┬─────────╮
│ # │ processed │ success │ failed │ failures │ cluster │
├───┼───────────┼─────────┼────────┼──────────┼─────────┤
│ 0 │       278 │     278 │      0 │          │ local   │
╰───┴───────────┴─────────┴────────┴──────────┴─────────╯
```

Here `vector enrich-text` will read each file, chunk the contents, retrieve the embeddings then generate the `vector docs`.

=== `ask`

```
> ask --help
Asks a connected LLM a question, optionally enhanced with context

Usage:
  > ask {flags} <question> (context)

Flags:
  -h, --help - Display the help message for this command
  --model <String> - the chat model to ask the question

Parameters:
  question <string>: the question to be asked
  context <any>: table of strings used as context for the question (optional)
```

`ask` can be used to ask a question of the <<_cb_env_llm,active large language model>>.
It can be used to answer a standalone question:

```
> ask "What is my favourite color"
I'm sorry, but as an assistant, I don't have access to personal information about you, such as your favorite color. If you'd like to share it with me, I'd be happy to remember it for future reference!
```

Or context can be provided for the question as a list of strings.
Either as a positional parameter:

```
> ask "What is my favourite color" ["My favourite color is blue"]
Your favourite color is blue.
```

This context can also be piped into the command which allows us to ask questions about docs in our database:

```
👤 Charlie 🏠 local in 🗄 travel-sample._default._default
> subdoc get content landmark_10019 | select content | ask "How much does it cost to go here?"
The admission price for an adult ticket is £6.99, which allows you to come back for further visits within a year. There are also tickets available for children and concessionary rates. Additionally, there is a collection of tank-mounted bridges and other outside attractions that can be seen for free. Special event weekends are included in the cost of the annual ticket.
```

Since the context can be a list we can also use `ask` to summarize the results from various documents:

```
👤 Charlie 🏠 local in 🗄 travel-sample._default._default
> [landmark_10019 landmark_10020] | subdoc get content | select content | ask "what activities can I do at these places?"
At the museum on military engineering and the history of the British Empire, you can explore various exhibits related to British and military history, as well as civil engineering. Activities may include:

1. Viewing exhibits on military equipment, vehicles, weapons, and uniforms.
2. Learning about the history of the British Empire and its impact on world events.
3. Participating in guided tours to gain more in-depth knowledge.
4. Attending special event weekends with themed activities and demonstrations.
5. Exploring the outside collection of tank-mounted bridges and other military hardware.

At the new restaurant, you can enjoy the following activities:

1. Dining on a menu that features burgers and ribs.
2. Appreciating the Hollywood-style decor and ambiance.
3. Socializing with friends or family in a lively atmosphere.
4. Trying out new dishes or drinks from the restaurant's menu.
5. Relaxing and unwinding in a cozy setting after a day of exploring or sightseeing.
```

The answering of questions with supplied context can be used to easily implement <<_rag_recipe,simple RAG>>.

=== `version`

The `version` command lists the version of the couchbase shell.

```
> version
╭─────────┬────────╮
│ version │ 0.92.0 │
╰─────────┴────────╯
```
